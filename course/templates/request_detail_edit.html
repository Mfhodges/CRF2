{% extends "base_generic.html" %}
{% load rest_framework %}
{% load template_extra %}

{% block content %}

<!--<h1>EDIT Request Detail</h1>-->


{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

<!-- DETAIL -->
<fieldset id="RequestForm">
  <legend>EDITING Request for {{request_instance.course_info|asrepr}}</legend>

  <dl class="row" style="line-height:1.1;">
        <dt class="col-4 col-md-3 text-right" style="padding-right: 0px;">Status</dt>
        <dd class="col-8 col-md-9"> {{ request_instance.status }}</dd>

        <dt class="col-4 col-md-3 text-right" style="padding-right: 0px;">Requestor</dt>
        <dd class="col-8 col-md-9"> {{ request_instance.owner }}
          {% if request_instance.masquerade %}
            ( as {{ request_instance.masquerade}} )
          {% endif %}
        </dd>

        <dt class="col-4 col-md-3 text-right" style="padding-right: 0px;">Created</dt>
        <dd class="col-8 col-md-9"> {{ request_instance.created }}</dd>

        <dt class="col-4 col-md-3 text-right" style="padding-right: 0px;">Updated</dt>
        <dd class="col-8 col-md-9"> {{ request_instance.updated }}</dd>
  </dl>

  {% if request_instance.course_info.crosslisted %}
  <div class="row" style="padding:0px 0px 0px 20px;">
    <dt class="" style="padding-right: 0px;">Request includes Crosslistings:</dt>
    <dd class="" style="padding-left: 10px;"> {{ request_instance.course_info.crosslisted| join:", " }}</dd>
  </div>
  {% endif %}
<!--END DETAIL -->

  <form enctype='application/json' action="{% url 'UI-request-detail' pk=request_instance.course_requested %}" method="put" id="RequestForm">
      {% csrf_token %}
      <input name="view_type" class="form-control" type="hidden" value="UI-request-detail">
      <input name='course_requested' value='{{request_instance.course_requested}}' type='hidden'>
      {% include "bits/request_form.html" with course=request_instance.course_requested %}
      <input type="submit" value="Update Request" />
  </form>
</fieldset>


<!-- Canvas Site info -->
{% include "bits/canvas_site_info.html" with course=request_instance.course_info %}

<div id="demo">
  <h2>Let AJAX change this text</h2>
  <button class="apireq">Change Content</button>
    <button class="apiadd">add Content</button>
</div>

{% endblock %}




{% block template_page_js %}
<script>

function addrow(){
  // should get lenght !
  var num = document.getElementById("additional_enrollments").childElementCount;
  var node = document.createElement("DIV");
  node.setAttribute("id","addEnroll-"+num);
  node.setAttribute("class","row");
  //node.appendChild(y);
  var id = "'additional_enrollments','addEnroll-"+num+"'";
  var name_user ="'additional_enrollments["+num+"][user]'"
  var name_role ="'additional_enrollments["+num+"][role]'"
  node.insertAdjacentHTML('beforeend',"<label style='width: 46%;'> user <input name="+name_user+" value='' class='form-control' type='text'> </label> <label> role  <select id='choose' name="+name_role+" style='width:130px;'> <option disabled selected>Please select</option> <option value='TA'>TA</option> <option value='DES'>Designer</option> <option value='LIB'>Librarian</option> </select> </label><a onClick=removeElement("+id+"); style='padding-top:30px;padding-left:5px;'> Delete <i class=\'fas fa-times\'></i></a>");
  document.getElementById("additional_enrollments").appendChild(node);
}

function removeElement(parentDiv, childDiv){
     if (childDiv == parentDiv) {
          alert("The parent div cannot be removed.");
     }
     else if (document.getElementById(childDiv)) {
          var child = document.getElementById(childDiv);
          var parent = document.getElementById(parentDiv);
          parent.removeChild(child);
     }
     else {
          alert("Child div has already been removed or does not exist.");
          return false;
     }
}
$('.apireq').click( function() {
    $.ajax({
             url : "http://127.0.0.1:8000/api/requests/{{request_instance.course_requested}}",
             dataType: "json",
             headers: {'X-CSRFTOKEN': '{{ csrf_token }}'},
             success : function (data) {
                      console.log(data['additional_enrollments']);
                    }
                 });
             });

 $('.apiadd').click( function() {

     $.ajax({
              url : "http://127.0.0.1:8000/api/requests/{{request_instance.course_requested}}/",
              headers: {
                          'X-CSRFTOKEN': '{{ csrf_token }}'
                      },
              type: "PUT",
              dataType: "json",
              //contentType: 'application/json',
              data: {"additional_enrollments": [{'user':'molly','role':'TA'}]},
              success: function(data){
                    console.log(data);
              }
              });
});

// before submit lets add all the additional_enrollments
/*
$('.form').onsubmit( function () {

});
*/

// removes null query_params ! <3
/*$('form[method="put"]').submit(function(){
    $(this).find(':input').each(function() {
        var inp = $(this);
        if (!inp.val()) {
            inp.remove();
        }
    });
});*/
/*
$('form[method="put"]').submit(function(){
  console.log("updated request values:");
    $(this).find(':input:not([type=hidden])').each(function() {
        var inp = $(this);
        if (inp.val()) {
            if (inp.val()=='None'){ inp.val('');}
            //if(inp.attr("name"=='reserves'){ inp.val() = 'True' })
            console.log(inp.attr("name"),": ", inp.val());
        }
      //  if (!inp.val()) {
        //    inp.remove();}
    });
});
*/
</script>

{% endblock %}
